name: CD â€” Deploy to server via SSH

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    needs: []
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to remote via SSH
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT || '22' }}
          script: |
            set -e
            cd ${{ secrets.DEPLOY_PATH }} || exit 1
            echo "Pulling latest code and building images on remote"
            # ensure repo is present and up-to-date
            if [ -d .git ]; then
              git fetch --all --prune
              git reset --hard origin/main
            else
              git clone https://github.com/${{ github.repository }} .
            fi
            # build images on the server and bring services up
            docker-compose -f docker-compose.deploy.yml build --pull
            docker-compose -f docker-compose.deploy.yml up -d --remove-orphans
            # simple healthcheck for Streamlit dashboard
            sleep 5
            if command -v curl >/dev/null 2>&1; then
              echo "Checking dashboard health on http://localhost:8501..."
              if curl --fail --max-time 10 http://localhost:8501/ >/dev/null 2>&1; then
                echo "Dashboard OK"
              else
                echo "Dashboard healthcheck failed" >&2
                exit 2
              fi
            else
              echo "curl not found on remote; skip healthcheck"
            fi
            docker image prune -f || true
