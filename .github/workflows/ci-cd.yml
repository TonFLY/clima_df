name: CI-CD

on:
  push:
    branches: [ "main", "master" ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      repo: ${{ steps.meta.outputs.repo }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Compute lowercase repo name
        id: meta
        run: |
          repo=$(echo "$GITHUB_REPOSITORY" | tr '[:upper:]' '[:lower:]')
          echo "repo=$repo" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ETL image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.etl
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/${{ steps.meta.outputs.repo }}:clima-etl-latest
            ghcr.io/${{ steps.meta.outputs.repo }}:clima-etl-${{ github.sha }}

      - name: Build and push Dashboard image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.dashboard
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/${{ steps.meta.outputs.repo }}:clima-dashboard-latest
            ghcr.io/${{ steps.meta.outputs.repo }}:clima-dashboard-${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.DEPLOY_HOST }}
          VPS_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH != '' && secrets.DEPLOY_PATH || '/home/deploy/app' }}
          IMAGE_ETL: ghcr.io/${{ needs.build-and-push.outputs.repo }}:clima-etl-${{ github.sha }}
          IMAGE_DASHBOARD: ghcr.io/${{ needs.build-and-push.outputs.repo }}:clima-dashboard-${{ github.sha }}
        run: |
          # sanitize secrets (remove CRLF/newlines and trim whitespace) to avoid invalid host/user
          safe_host=$(echo "$VPS_HOST" | tr -d '\r' | xargs)
          safe_user=$(echo "$VPS_USER" | tr -d '\r' | xargs)
          ssh -o StrictHostKeyChecking=no "$safe_user@$safe_host" "IMAGE_ETL=$IMAGE_ETL IMAGE_DASHBOARD=$IMAGE_DASHBOARD DEPLOY_PATH=$DEPLOY_PATH bash -s" <<'EOF'
          set -e
          export IMAGE_ETL="${IMAGE_ETL}"
          export IMAGE_DASHBOARD="${IMAGE_DASHBOARD}"
          export DEPLOY_PATH="${DEPLOY_PATH:-/home/deploy/app}"

          mkdir -p "$DEPLOY_PATH"
          cd "$DEPLOY_PATH"

          cat > docker-compose.yml <<COMPOSE
          version: "3.9"
          services:
            etl:
              image: ${IMAGE_ETL}
              restart: unless-stopped
              env_file:
                - .env
            dashboard:
              image: ${IMAGE_DASHBOARD}
              restart: unless-stopped
              env_file:
                - .env
              ports:
                - "8501:8501"
          COMPOSE

          # pull and start
          docker compose pull || true
          docker compose up -d --remove-orphans
          EOF