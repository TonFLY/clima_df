name: CI-CD

on:
  push:
    branches: [ "main", "master" ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      repo: ${{ steps.meta.outputs.repo }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Compute lowercase repo name
        id: meta
        run: |
          repo=$(echo "$GITHUB_REPOSITORY" | tr '[:upper:]' '[:lower:]')
          echo "repo=$repo" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ETL image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.etl
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/${{ steps.meta.outputs.repo }}:clima-etl-latest
            ghcr.io/${{ steps.meta.outputs.repo }}:clima-etl-${{ github.sha }}

      - name: Build and push Dashboard image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.dashboard
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/${{ steps.meta.outputs.repo }}:clima-dashboard-latest
            ghcr.io/${{ steps.meta.outputs.repo }}:clima-dashboard-${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.DEPLOY_HOST }}
          VPS_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH != '' && secrets.DEPLOY_PATH || '/home/deploy/app' }}
          IMAGE_ETL: ghcr.io/${{ needs.build-and-push.outputs.repo }}:clima-etl-${{ github.sha }}
          IMAGE_DASHBOARD: ghcr.io/${{ needs.build-and-push.outputs.repo }}:clima-dashboard-${{ github.sha }}
        run: |
          # sanitize secrets (remove CRLF/newlines and trim whitespace) to avoid invalid host/user
          safe_host=$(echo "$VPS_HOST" | tr -d '\r' | xargs)
          safe_user=$(echo "$VPS_USER" | tr -d '\r' | xargs)
          # escape values for safe inlining into here-doc
          IMAGE_ETL_ESC=$(printf '%q' "$IMAGE_ETL")
          IMAGE_DASHBOARD_ESC=$(printf '%q' "$IMAGE_DASHBOARD")
          DEPLOY_PATH_ESC=$(printf '%q' "$DEPLOY_PATH")

          # run remote bash and feed the deployment script via here-doc (variables already escaped)
          ssh -o StrictHostKeyChecking=no "$safe_user@$safe_host" 'bash -s' <<EOF
          set -e
          IMAGE_ETL=$IMAGE_ETL_ESC
          IMAGE_DASHBOARD=$IMAGE_DASHBOARD_ESC
          DEPLOY_PATH=
          if [ -n "$DEPLOY_PATH_ESC" ]; then
            DEPLOY_PATH=$DEPLOY_PATH_ESC
          else
            DEPLOY_PATH=/home/deploy/app
          fi

          mkdir -p "$DEPLOY_PATH"
          cd "$DEPLOY_PATH"

          # prepare database url and other secrets escaped for remote
          DATABASE_URL_ESC=$(printf '%q' "${{ secrets.DATABASE_URL }}")
          OPEN_METEO_ESC=$(printf '%q' "${{ secrets.OPEN_METEO_ENDPOINT }}")
          # write docker-compose with secrets embedded (no .env file)

          cat > docker-compose.yml <<COMPOSE
          version: "3.9"
          services:
            etl:
              image: ${IMAGE_ETL}
              restart: unless-stopped
              environment:
                - DATABASE_URL=${DATABASE_URL_ESC}
                - TZ=America/Sao_Paulo
                - OPEN_METEO_ENDPOINT=${OPEN_METEO_ESC}
            dashboard:
              image: ${IMAGE_DASHBOARD}
              restart: unless-stopped
              environment:
                - DATABASE_URL=${DATABASE_URL_ESC}
                - TZ=America/Sao_Paulo
                - OPEN_METEO_ENDPOINT=${OPEN_METEO_ESC}
              ports:
                - "8501:8501"
          COMPOSE

          # pull and start
          docker compose pull || true
          docker compose up -d --remove-orphans
          EOF